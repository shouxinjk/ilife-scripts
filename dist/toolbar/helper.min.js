var _sxdebug=!0,brokerName="请登录",brokerLogo="https://biglistoflittlethings.com/ilife-web-wx/images/icon.jpeg",loginUrl="https://sidebar.biglistoflittlethings.com/login?origin=helper";function sxInitialize(t){listenPostMessage();var e="";e+='<div id="sxHideBtnDiv" class="sxinfo" style="position:fixed;z-index:2147483647;top:0px;right:0px;background-color:#fff;width:50px;height:20px;border-radius:5px;display:none">',e+='<div style="line-height:22px;color:grey;background-color:#fff">隐藏</div>',e+="</div>",e+='<div id="sxShowBtnDiv" class="sxinfo" style="position:fixed;z-index:2147483647;top:0px;right:0;background-color:#fff;width:44px;height:150px;border-radius:5px;padding-left:12px;display:block">',e+='<div class="info-general">',e+='<img class="general-icon" src="'+brokerLogo+'" width="30" height="30"/>',e+="</div>",e+='<div class="info-detail" style="text-align:left">',e+='<div class="info-text info-blank" style="color:#000;font-size:14px;height:100px;background-color:#fff">智<br/>能<br/>助<br/>手</div>',e+="</div>",t.append(e);var o="";o+="<div id='sxDiv' style='position:fixed;z-index:2147483646;top:0px;right:0px;background-color:#fff;min-width:400px;width:20%;height:100%;border-radius:5px;display:none;border-left:1px solid silver;'>",o+='<div id="brokerInfoDiv" class="sxinfo" style="background-image:none;">',o+='<div class="info-general">',o+='<img id="broker-logo" class="general-icon" src="'+brokerLogo+'" height="60px" style="margin:10px auto;"/>',o+="</div>",o+='<div class="info-detail" style="text-align:left">',o+='<div id="broker-name" class="info-text info-blank" style="color:#000;font-weight:bold;font-size:14px;">'+brokerName+"</div>",o+='<div class="info-text info-blank" id="brokerHint"  style="color:#000">确幸智能助手</div>',o+="</div>",o+="</div>",o+='<div id="sxListDiv" class="list">',o+='<iframe id="sxListFrame" src="'+loginUrl+'" width="100%" height="400px" frameborder="0" sandbox="allow-scripts allow-same-origin">',o+="</div>",o+="</div>",t.append(o),_sxdebug&&console.log("post message to get sxToolbarStatus "),document.getElementById("sxListFrame").contentWindow.postMessage({action:"checkToolbarStatus"},"*");var s=$("#sxDiv").height()-$("#brokerInfoDiv").height();$("#sxListFrame").height(s);try{showToolbar(JSON.parse(localStorage.getItem("sxToolbarStatus")))}catch(t){}$("#sxHideBtnDiv").click(function(t){$("#sxHideBtnDiv").css("display","none"),$("#sxShowBtnDiv").css("display","block"),$("#sxDiv").css("display","none"),localStorage.setItem("sxToolbarStatus",JSON.stringify({show:!1}))}),$("#sxShowBtnDiv").click(function(t){$("#sxShowBtnDiv").css("display","none"),$("#sxHideBtnDiv").css("display","block"),$("#sxDiv").css("display","block"),localStorage.setItem("sxToolbarStatus",JSON.stringify({show:!0}))})}function showToolbar(t){t&&(t.show?($("#sxShowBtnDiv").css("display","none"),$("#sxHideBtnDiv").css("display","block"),$("#sxDiv").css("display","block")):($("#sxShowBtnDiv").css("display","block"),$("#sxHideBtnDiv").css("display","none"),$("#sxDiv").css("display","none")))}function updateToolbarInfo(t){if(t){console.log("update toolbar with userInfo.",t);var e="Hi,"+t.username+(t.sxBrokerOrgnization&&t.sxBrokerOrgnization.trim().length>0?"("+t.sxBrokerOrgnization+")":"");e+="&nbsp;<a href='#' style='font-size:12px;color:silver;text-decoration:none' id='sxChangeBroker' alt='切换账户'><span style='width:12px;height:12px;'>⇌</span></a>",$("#broker-name").html(e),t.avatar&&$("#broker-logo").attr("src",t.avatar),$("#sxChangeBroker").click(function(t){_sxdebug&&console.log("try to remove broker info."),document.getElementById("sxListFrame").contentWindow.postMessage({action:"logout"},"*"),$("#broker-name").html(brokerName),$("#broker-logo").attr("src",brokerLogo),clearInterval(timer),$("#sxListFrame").attr("src",loginUrl)})}}function listenPostMessage(){var t=window.addEventListener?"addEventListener":"attachEvent";(0,window[t])("attachEvent"==t?"onmessage":"message",function(t){var e=t[t.message?"message":"data"];_sxdebug&&console.log("got message from child window.",e),e&&"sxSendMsg"==e.action&&e.content&&e.content.trim().length>0&&(console.log("action: send msg",e.content),$("div.simulate-textarea").text(e.content),console.log("got btn.",$(".chat_area-button button[title='发送消息']"))),e&&"sxLogin"==e.action&&e.data&&(console.log("action: change toolbar status",e.data),e.data.userInfo&&(localStorage.setItem("sxUserInfo",e.data.userInfo),updateToolbarInfo(e.data.userInfo))),e&&"sxToolbarStatus"==e.action&&e.data&&(console.log("action: change toolbar status",e.data),e.data.userInfo&&(localStorage.setItem("sxUserInfo",e.data.userInfo),updateToolbarInfo(e.data.userInfo))),e&&"sxRediret"==e.action&&e.url&&e.url.trim().length>0&&(console.log("action: redirect",e.url),window.open(e.url)),e&&"sxSopCustomer"==e.action&&e.sop&&(console.log("action: sxSopCustomer",e.sop),timeoutAutoReply=e.sop.threshold?e.sop.threshold:180,timeoutNotify=timeoutAutoReply-180>0?timeoutAutoReply-180:timeoutAutoReply/2,loopCustomerMsgs())},!1)}var timerInterval=300,timeoutNotify=120,timeoutAutoReply=180,sxTimers=new Array,companyName="四川和邦国际旅行社有限责任公司万和路分公司",testSent=!1,timer=null;function loopCustomerMsgs(){var t=(new Date).getTime();timer=setInterval(function(){$(".im_friend-queue li>a").each(function(){var e={channelName:"vBooking",channelType:"ota",contentType:"text",toUser:$(this).find("strong.nick").text(),fromUser:$(this).find("em.message-name").text(),msg:$(this).find("em.newmessage").text(),time:$(this).find("span.date").text(),startTimeout:t,notifyTimeout:t+1e3*timeoutNotify,autoReplyTimeout:t+1e3*timeoutAutoReply};testSent||(document.getElementById("sxListFrame").contentWindow.postMessage({action:"sendAutoReply",data:e},"*"),testSent=!0);var o=sxTimers.findIndex(t=>t.toUser==e.toUser);if(o>=0){var s=sxTimers[o];s.notifyTimeout&&s.notifyTimeout>=t-timerInterval?(console.log("msg timeout notify.",s),document.getElementById("sxListFrame").contentWindow.postMessage({action:"sendNotify",data:e},"*"),s.notifyTimeout=null,sxTimers.splice(o,1,s)):s.autoReplyTimeout&&s.autoReplyTimeout>=t-timerInterval?(console.log("msg timeout autoreply.",s),$("div.simulate-textarea").text("auto reply test"),document.getElementById("sxListFrame").contentWindow.postMessage({action:"sendAutoReply",data:e},"*"),s.notifyTimeout=null,s.autoReplyTimeout=null,sxTimers.splice(o,1,s)):console.log("timer countinue.",s)}else e.fromUser!=companyName?sxTimers.push(e):(console.log("clear timer",e),sxTimers.splice(o,1))})},timerInterval)}